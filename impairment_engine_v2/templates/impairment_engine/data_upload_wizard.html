{% extends 'impairment_engine/base.html' %}
{% load static %}

{% block content %}
<div class="container d-flex justify-content-center py-4">
  <div class="col-lg-8">
    <div class="card my-4">
      <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
        <div class="bg-gradient-secondary shadow-primary border-radius-lg pt-4 pb-3">
          <h6 class="text-white text-capitalize text-center ps-3">
            <i class="fas fa-upload me-2"></i>Data Upload Wizard - Step {{ step }}
          </h6>
        </div>
      </div>

      <div class="card-body">
        {% if step == 1 %}
          <!-- Step 1: File Upload -->
          <form method="post" enctype="multipart/form-data" action="{% url 'upload_wizard' company_slug=company_slug project_slug=project_slug %}" id="uploadForm">
            {% csrf_token %}

            <div class="file-upload-wrapper mb-4">
              <div class="file-upload-container border rounded p-5 text-center">
<!--                <i class="fas fa-file-excel text-primary mb-3" style="font-size: 3rem;"></i>-->
                <h5 class="mb-2">Upload Loans and Arrears Excel data file</h5>
                <p class="text-muted mb-3">Supports .xlsx and .xls formats</p>

                <label class="btn btn-outline-primary px-4">
                  <i class="fas fa-folder-open me-2"></i>Browse Files
                  <input type="file" class="d-none" name="excel_file" accept=".xlsx,.xls" required>
                </label>
                <div class="mt-3">
                  <small class="text-muted">Selected file: <span id="file-name">None</span></small>
                </div>
              </div>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-primary px-4" id="uploadBtn">
                <span class="btn-text">Next: Select Sheets</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>

        {% elif step == 2 %}
        <!-- Step 2: Sheet Selection -->
        <form method="post" action="{% url 'process_sheets' company_slug=company_slug project_slug=project_slug %}" id="sheetsForm">
          {% csrf_token %}

          <div class="form-group mb-4">
            <label class="form-label"><i class="fas fa-table me-2"></i>Select Loan Data Sheet</label>
            <select class="form-select" name="loan_sheet" required>
              <option value="">-- Select --</option>
              {% for sheet in sheet_names %}
              <option value="{{ sheet }}">{{ sheet }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group mb-4">
            <label class="form-label"><i class="fas fa-table me-2"></i>Select Arrears Data Sheet</label>
            <select class="form-select" name="arrears_sheet" required>
              <option value="">-- Select --</option>
              {% for sheet in sheet_names %}
              <option value="{{ sheet }}">{{ sheet }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="text-center">
            <button type="submit" class="btn bg-gradient-primary" id="sheetsBtn">
              <span class="btn-text">Next: Map Columns</span>
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </form>

        {% elif step == 3 %}
          <!-- Step 3: Column Mapping -->
          <form method="post" action="{% url 'process_mapping' company_slug=company_slug project_slug=project_slug %}" id="mappingForm">
            {% csrf_token %}

            <div class="mb-4">
              <h5 class="fw-semibold mb-3 pb-2 border-bottom">
                <i class="fas fa-list-alt me-2"></i>Loan Data Column Mapping
              </h5>

              <div class="row g-3">
                {% for field_name, description, is_required in loan_field_config %}
                  {% if is_required %}
                    <div class="col-md-6">
                      <label class="form-label">
                        <i class="fas fa-columns me-2 text-muted"></i>{{ description }}
                        {% if not is_required %}<span class="text-muted">*</span>{% endif %}
                      </label>
                      <select class="form-select" name="loan_{{ field_name }}" {% if is_required %}required{% endif %}>
                        <option value="">-- Select Column --</option>
                        {% for column in loan_columns %}
                        <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                      </select>
                      {% if not is_required %}
                        <small class="form-text text-muted">
                          {% if field_name == 'loan_tenor' %}
                            Will be calculated as: maturity_date - opening_date
                          {% elif field_name == 'days_to_maturity' %}
                            Will be calculated as: maturity_date - today
                          {% endif %}
                        </small>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>

            <div class="mb-4">
              <h5 class="fw-semibold mb-3 pb-2 border-bottom">
                <i class="fas fa-list-alt me-2"></i>Arrears Data Column Mapping
              </h5>

              <div class="row g-3">
                {% for field_name, description, is_required in arrears_field_config %}
                  {% if is_required %}
                    <div class="col-md-6">
                      <label class="form-label">
                        <i class="fas fa-columns me-2 text-muted"></i>{{ description }}
                        {% if not is_required %}<span class="text-muted">*</span>{% endif %}
                      </label>
                      <select class="form-select" name="arrears_{{ field_name }}" {% if is_required %}required{% endif %}>
                        <option value="">-- Select Column --</option>
                        {% for column in arrears_columns %}
                        <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                      </select>
                      {% if field_name == 'exposure' %}
                        <small class="form-text text-muted">
                          Will be calculated as: capital_balance + arrears_amount
                        </small>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-primary px-4" id="mappingBtn">
                <span class="btn-text">Complete Upload</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Show selected file name
  document.querySelector('input[type="file"]')?.addEventListener('change', function(e) {
    const fileName = e.target.files[0] ? e.target.files[0].name : 'None';
    document.getElementById('file-name').textContent = fileName;
  });

  // Loading indicators for all forms
  document.getElementById('uploadForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.querySelector('.btn-text').classList.add('d-none');
    btn.querySelector('.spinner-border').classList.remove('d-none');
  });

  document.getElementById('sheetsForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('sheetsBtn');
    btn.disabled = true;
    btn.querySelector('.btn-text').classList.add('d-none');
    btn.querySelector('.spinner-border').classList.remove('d-none');
  });

  document.getElementById('mappingForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('mappingBtn');
    btn.disabled = true;
    btn.querySelector('.btn-text').classList.add('d-none');
    btn.querySelector('.spinner-border').classList.remove('d-none');
  });
</script>

<style>
  .file-upload-container {
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload-container:hover {
    background-color: #f1f3f5;
  }

  /* Smooth transition for button states */
  button .spinner-border {
    transition: opacity 0.3s ease;
  }

  button .btn-text {
    transition: opacity 0.3s ease;
  }
</style>
{% endblock %}